# 13장 동시성

# Questions

1. 

# Organize

## 동시성이 필요한 이유

1. 구조적 개선

    동시성은 **무엇**과 **언제**를 ****분리하는, **결합**을 없애는 전략.

2. 작업 처리량 개선

    응답 시간과 작업 처리량을 개선하기 위한 목적

### 미신과 오해

- 항상 성능을 높여준다

    >> **때로** 성능을 높여준다

- 동시성을 구현해도 계는 변하지 않는다

    >> 단일/다중 스레드 시스템 설계는 완전 다르다.

- 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다.

    >> 실제론 컨테이너가 어떻게 동작하는지, 동시수정/데드락 같은 문제를 어떻게 피할 지 알아야 한다.

### 타당한 생각

- 동시성은 부하를 유발한다.
- 복잡하다.
- 버그 재현이 어렵다.
- 근본적인 설계 전략을 재고해야 한다.

## 난관

## 동시성 방어 원칙

### 단일 책임 원칙

SRP는 주어진 메서드/클래스/컴포넌트를 변경할 이유가 하나여야 한다는 원칙이다. 그러므로 동시성은 복잡성 하나만으로 **따로 분리해야 한다**.

동시성 구현 시 고려 요소

- 독자적인 개발, 변경, 조율 주기가 있다.
- 독자적 난관이 있다.
- 버라이어티한 실패들이 나타난다. 동시성 자체만으로도 충분히 어렵다.

### 따름 정리 ( 자료 범위를 제한하라 )

객체 하나를 두 스레드가 동일 필드를 수정하여 서로 간섭하는 문제가 발생한다.

이 문제를 해결하는 방안으로 공유 객체를 사용하는 코드 내 임계영역을 synchronized 키워드로 보호한다. 그리고 임계영역의 수를 줄이는 기술이 중요하다.

** 권장사항 : 자료를 **캡슐화**. 공유 자료를 **최소화**.

### 따름 정리 ( 자료 사본을 사용하라 )

객체를 복사해 읽기 전용으로 사용하거나, 복사해 사용한 후 한 스레드가 해당 사본에서 결과를 가져오는 방법도 가능하다.

즉, 사본으로 동기화를 피해 내부 잠금을 없애자.

### 따름 정리 ( 스레드는 가능한 독립적으로 )

가능하면 다른 프로세서에서 독자적인 스레드로 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라.

## 라이브러리를 이해하라

자바5로 스레드 코드 구현 시 고려 사항

- 스레드 환경에 안전한 컬렉션 사용
- 서로 무관한 작업 수행 시 executor 프레임워크 사용
- 가능하다면 스레드가 차단되지 않는 방법 사용
- 일부 클래스 라이브러리는 스레드에 안전하지 못함

### 스레드 환경에 안전한 컬렉션

- ReentrantLock : 한 메서드에서 잠그고 다른 메서드에서 푸는 락
- Semaphore : 세마포어
- CountDownLatch : 지정한 수 만큼 이벤트 발생하고서야 대기 중인 스레드를 모두 해제하는 락. 모든 스레드가 공평하게 시작할 수 있다.

권장사항 : 언어가 제공하는 클래스 검토 ( 자바 : java.util.concurrent, atomic, concurrent.locks 패키지 사용)

## 실행 모델 이해

** 다중 스레드 관련 용어

- 한정된 자원
- 상호 배제 : 한 번에 한 스레드만 공유 자료나 공유 자원을 사용할 수 있는 경우
- 기아 : 굉장히 오래 혹은 영원히 자원을 기다린다.
- 데드락
- 라이브락

### 생산자-소비자

하나 이상 생산자 스레드가 정보를 생성해 버퍼*buffer*나 대기열*Queue*에 넣는다.

하나 이상 소비자 스레드가 대기열에서 정보를 가져와 사용한다.